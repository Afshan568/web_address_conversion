<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual to Physical Address Conversion</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .input-section, .page-table-section, .conversion-section {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .error {
            color: red;
            margin-bottom: 15px;
        }
        .success {
            color: green;
            margin-bottom: 15px;
        }
        .fifo-queue {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Virtual to Physical Address Conversion</h1>
    
    <div class="container">
        <div class="input-section">
            <h2>System Configuration</h2>
            <label for="virtualSpace">Virtual Space Size (bytes):</label>
            <input type="number" id="virtualSpace" min="1" value="4096">
            
            <label for="physicalSpace">Physical Space Size (bytes):</label>
            <input type="number" id="physicalSpace" min="1" value="2048">
            
            <label for="pageSize">Page Size (bytes):</label>
            <input type="number" id="pageSize" min="1" value="512">
            
            <button id="validateBtn">Validate Configuration</button>
            <div id="configError" class="error"></div>
            <div id="configSuccess" class="success"></div>
            
            <div id="autoCorrectSection" style="display: none;">
                <p>Recommended corrections:</p>
                <div id="recommendations"></div>
                <button id="acceptCorrectionBtn">Accept Correction</button>
                <button id="ignoreCorrectionBtn">Ignore Correction</button>
            </div>
            
            <h2>Page Access Sequence</h2>
            <label for="accessSequence">Access Sequence (comma-separated virtual pages):</label>
            <input type="text" id="accessSequence" placeholder="e.g., 0,1,2,0,3">
            <button id="simulateBtn">Simulate Accesses</button>
        </div>
        
        <div class="page-table-section">
            <h2>Page Table</h2>
            <div id="pageTableContainer"></div>
            
            <h3>FIFO Replacement Queue</h3>
            <div id="fifoQueue" class="fifo-queue"></div>
        </div>
    </div>
    
    <div class="container">
        <div class="conversion-section">
            <h2>Address Conversion</h2>
            <label for="conversionType">Conversion Type:</label>
            <select id="conversionType">
                <option value="virtualToPhysical">Virtual to Physical</option>
                <option value="physicalToVirtual">Physical to Virtual</option>
            </select>
            
            <label for="inputAddress">Address (decimal):</label>
            <input type="number" id="inputAddress" min="0" placeholder="e.g., 670">
            
            <button id="convertBtn">Convert Address</button>
            <div id="conversionResult"></div>
            <div id="conversionError" class="error"></div>
        </div>
    </div>
    
    <script>
    // System state
    let systemConfig = {
        virtualSpace: 4096,  // bytes
        physicalSpace: 2048, // bytes
        pageSize: 512,       // bytes
        valid: false
    };

    let pageTable = [];
    let fifoQueue = [];
    let pageFaults = 0;

    // DOM elements
    const virtualSpaceInput = document.getElementById('virtualSpace');
    const physicalSpaceInput = document.getElementById('physicalSpace');
    const pageSizeInput = document.getElementById('pageSize');
    const validateBtn = document.getElementById('validateBtn');
    const configError = document.getElementById('configError');
    const configSuccess = document.getElementById('configSuccess');
    const autoCorrectSection = document.getElementById('autoCorrectSection');
    const recommendationsDiv = document.getElementById('recommendations');
    const acceptCorrectionBtn = document.getElementById('acceptCorrectionBtn');
    const ignoreCorrectionBtn = document.getElementById('ignoreCorrectionBtn');
    const accessSequenceInput = document.getElementById('accessSequence');
    const simulateBtn = document.getElementById('simulateBtn');
    const pageTableContainer = document.getElementById('pageTableContainer');
    const fifoQueueDiv = document.getElementById('fifoQueue');
    const conversionTypeSelect = document.getElementById('conversionType');
    const inputAddress = document.getElementById('inputAddress');
    const convertBtn = document.getElementById('convertBtn');
    const conversionResult = document.getElementById('conversionResult');
    const conversionError = document.getElementById('conversionError');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOMContentLoaded fired');
        validateBtn.addEventListener('click', () => {
            console.log('Validate button clicked');
            validateConfiguration();
        });
        acceptCorrectionBtn.addEventListener('click', acceptCorrection);
        ignoreCorrectionBtn.addEventListener('click', ignoreCorrection);
        simulateBtn.addEventListener('click', simulateAccesses);
        convertBtn.addEventListener('click', performConversion);
        
        // Initialize page table
        validateConfiguration();
    });

    function validateConfiguration() {
        console.log('validateConfiguration called');
        configError.textContent = '';
        configSuccess.textContent = '';
        autoCorrectSection.style.display = 'none';
        
        const virtualSpace = parseInt(virtualSpaceInput.value);
        const physicalSpace = parseInt(physicalSpaceInput.value);
        const pageSize = parseInt(pageSizeInput.value);
        
        console.log('Inputs:', { virtualSpace, physicalSpace, pageSize });
        
        let errors = [];
        let recommendations = [];
        
        // Basic checks
        if (!virtualSpace || virtualSpace <= 0) {
            errors.push('Virtual space must be positive.');
        }
        if (!physicalSpace || physicalSpace <= 0) {
            errors.push('Physical space must be positive.');
        }
        if (!pageSize || pageSize <= 0) {
            errors.push('Page size must be positive.');
        }
        
        // Check physical space ratio
        if (virtualSpace && physicalSpace && physicalSpace !== virtualSpace / 2) {
            errors.push(`Physical space should be half of virtual space (${virtualSpace / 2} bytes).`);
            recommendations.push(`Set physical space to ${virtualSpace / 2} bytes.`);
        }
        
        // Check divisibility
        if (virtualSpace && pageSize && virtualSpace % pageSize !== 0) {
            errors.push(`Virtual space (${virtualSpace} bytes) must be divisible by page size (${pageSize} bytes).`);
            recommendations.push(`Set page size to a divisor of ${virtualSpace} (e.g., ${findDivisor(virtualSpace)}).`);
        }
        if (physicalSpace && pageSize && physicalSpace % pageSize !== 0) {
            errors.push(`Physical space (${physicalSpace} bytes) must be divisible by page size (${pageSize} bytes).`);
            recommendations.push(`Set page size to a divisor of ${physicalSpace} (e.g., ${findDivisor(physicalSpace)}).`);
        }
        
        console.log('Validation results:', { errors, recommendations });
        
        if (errors.length > 0) {
            configError.innerHTML = errors.join('<br>');
            recommendationsDiv.innerHTML = recommendations.join('<br>');
            autoCorrectSection.style.display = 'block';
            systemConfig.valid = false;
            pageTableContainer.innerHTML = '<p>Please configure a valid system.</p>';
        } else {
            configSuccess.textContent = 'Configuration is valid!';
            systemConfig = {
                virtualSpace,
                physicalSpace,
                pageSize,
                valid: true
            };
            initializePageTable();
            updatePageTable();
        }
    }

    function acceptCorrection() {
        console.log('acceptCorrection called');
        const virtualSpace = parseInt(virtualSpaceInput.value);
        const pageSize = parseInt(pageSizeInput.value);
        
        // Set physical space to half of virtual space
        if (virtualSpace) {
            physicalSpaceInput.value = virtualSpace / 2;
        }
        
        // Find a valid page size that divides both
        if (virtualSpace && physicalSpaceInput.value) {
            let newPageSize = pageSize;
            while (newPageSize > 1 && (virtualSpace % newPageSize !== 0 || physicalSpaceInput.value % newPageSize !== 0)) {
                newPageSize = findDivisor(Math.min(virtualSpace, physicalSpaceInput.value));
            }
            pageSizeInput.value = newPageSize;
        }
        
        autoCorrectSection.style.display = 'none';
        validateConfiguration();
    }

    function ignoreCorrection() {
        console.log('ignoreCorrection called');
        autoCorrectSection.style.display = 'none';
        systemConfig = {
            virtualSpace: parseInt(virtualSpaceInput.value),
            physicalSpace: parseInt(physicalSpaceInput.value),
            pageSize: parseInt(pageSizeInput.value),
            valid: true
        };
        configSuccess.textContent = 'Configuration accepted.';
        initializePageTable();
        updatePageTable();
    }

    function initializePageTable() {
        console.log('initializePageTable called');
        const virtualPages = systemConfig.virtualSpace / systemConfig.pageSize;
        pageTable = [];
        fifoQueue = [];
        pageFaults = 0;
        
        for (let i = 0; i < virtualPages; i++) {
            pageTable.push({
                virtualIndex: i,
                physicalIndex: null,
                present: false
            });
        }
    }

    function updatePageTable() {
        console.log('updatePageTable called');
        if (!systemConfig.valid) {
            pageTableContainer.innerHTML = '<p>Please configure a valid system first.</p>';
            return;
        }
        
        const virtualPages = systemConfig.virtualSpace / systemConfig.pageSize;
        const physicalPages = systemConfig.physicalSpace / systemConfig.pageSize;
        
        let html = `
            <p>Virtual Pages: ${virtualPages}, Physical Pages: ${physicalPages}</p>
            <table>
                <thead>
                    <tr>
                        <th>Virtual Index</th>
                        <th>Physical Index</th>
                        <th>Present</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        for (const entry of pageTable) {
            html += `
                <tr>
                    <td>${entry.virtualIndex}</td>
                    <td>${entry.physicalIndex !== null ? entry.physicalIndex : 'None'}</td>
                    <td>${entry.present ? 'Yes' : 'No'}</td>
                </tr>
            `;
        }
        
        html += `</tbody></table>`;
        pageTableContainer.innerHTML = html;
        
        updateFifoQueueDisplay();
    }

    function updateFifoQueueDisplay() {
        console.log('updateFifoQueueDisplay called');
        fifoQueueDiv.innerHTML = `
            <p>Page Faults: ${pageFaults}</p>
            <p>FIFO Queue: [${fifoQueue.join(', ')}]</p>
        `;
    }

    function simulateAccesses() {
        console.log('simulateAccesses called');
        if (!systemConfig.valid) {
            configError.textContent = 'Please configure a valid system first.';
            return;
        }
        
        const sequence = accessSequenceInput.value.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
        const virtualPages = systemConfig.virtualSpace / systemConfig.pageSize;
        
        for (const vp of sequence) {
            if (vp < 0 || vp >= virtualPages) {
                configError.textContent = `Invalid virtual page: ${vp}`;
                return;
            }
            
            const pageEntry = pageTable[vp];
            if (!pageEntry.present) {
                handlePageFault(pageEntry);
            } else {
                // Move to end of FIFO queue to reflect recent access
                fifoQueue = fifoQueue.filter(x => x !== vp);
                fifoQueue.push(vp);
            }
        }
        
        updatePageTable();
        configSuccess.textContent = 'Access sequence simulated successfully!';
    }

    function handlePageFault(pageEntry) {
        console.log('handlePageFault called for page', pageEntry.virtualIndex);
        const physicalPages = systemConfig.physicalSpace / systemConfig.pageSize;
        let physicalIndex;
        
        // Check for free physical page
        const freePhysicalPage = findFreePhysicalPage();
        if (freePhysicalPage !== null) {
            physicalIndex = freePhysicalPage;
        } else {
            // Replace using FIFO
            const victimVirtualIndex = fifoQueue.shift();
            const victimEntry = pageTable[victimVirtualIndex];
            physicalIndex = victimEntry.physicalIndex;
            victimEntry.physicalIndex = null;
            victimEntry.present = false;
        }
        
        pageEntry.physicalIndex = physicalIndex;
        pageEntry.present = true;
        fifoQueue.push(pageEntry.virtualIndex);
        pageFaults++;
    }

    function findFreePhysicalPage() {
        console.log('findFreePhysicalPage called');
        const physicalPages = systemConfig.physicalSpace / systemConfig.pageSize;
        const usedPhysicalPages = new Set(pageTable.filter(entry => entry.present).map(entry => entry.physicalIndex));
        
        for (let i = 0; i < physicalPages; i++) {
            if (!usedPhysicalPages.has(i)) {
                return i;
            }
        }
        return null;
    }

    function performConversion() {
        console.log('performConversion called');
        conversionResult.textContent = '';
        conversionError.textContent = '';
        
        if (!systemConfig.valid) {
            conversionError.textContent = 'Please configure a valid system first.';
            return;
        }
        
        let addressValue = parseInt(inputAddress.value);
        if (isNaN(addressValue) || addressValue < 0) {
            conversionError.textContent = 'Invalid address.';
            return;
        }
        
        const conversionType = conversionTypeSelect.value;
        const virtualPages = systemConfig.virtualSpace / systemConfig.pageSize;
        const physicalPages = systemConfig.physicalSpace / systemConfig.pageSize;
        
        if (conversionType === 'virtualToPhysical') {
            if (addressValue >= systemConfig.virtualSpace) {
                conversionError.textContent = `Virtual address ${addressValue} exceeds virtual space (${systemConfig.virtualSpace}).`;
                return;
            }
            
            const virtualPageIndex = Math.floor(addressValue / systemConfig.pageSize);
            const offset = addressValue % systemConfig.pageSize;
            const pageEntry = pageTable[virtualPageIndex];
            
            if (!pageEntry.present) {
                conversionError.textContent = `Page fault: Virtual page ${virtualPageIndex} not in memory.`;
                return;
            }
            
            const physicalAddress = (pageEntry.physicalIndex * systemConfig.pageSize) + offset;
            conversionResult.innerHTML = `
                <p>Virtual Address: ${addressValue}</p>
                <p>Virtual Page: ${virtualPageIndex}, Offset: ${offset}</p>
                <p>Physical Page: ${pageEntry.physicalIndex}</p>
                <p>Physical Address: ${physicalAddress}</p>
            `;
        } else {
            if (addressValue >= systemConfig.physicalSpace) {
                conversionError.textContent = `Physical address ${addressValue} exceeds physical space (${systemConfig.physicalSpace}).`;
                return;
            }
            
            const physicalPageIndex = Math.floor(addressValue / systemConfig.pageSize);
            const offset = addressValue % systemConfig.pageSize;
            const pageEntry = pageTable.find(entry => entry.present && entry.physicalIndex === physicalPageIndex);
            
            if (!pageEntry) {
                conversionError.textContent = `No virtual page mapped to physical page ${physicalPageIndex}.`;
                return;
            }
            
            const virtualAddress = (pageEntry.virtualIndex * systemConfig.pageSize) + offset;
            conversionResult.innerHTML = `
                <p>Physical Address: ${addressValue}</p>
                <p>Physical Page: ${physicalPageIndex}, Offset: ${offset}</p>
                <p>Virtual Page: ${pageEntry.virtualIndex}</p>
                <p>Virtual Address: ${virtualAddress}</p>
            `;
        }
    }

    // Helper functions
    function findDivisor(n) {
        console.log('findDivisor called for', n);
        for (let i = n; i >= 1; i--) {
            if (n % i === 0) return i;
        }
        return 1;
    }
    </script>
</body>
</html>